<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permission Saving Fix</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        .info { color: #4488ff; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #333; color: #fff; border: 1px solid #555; 
            padding: 8px 16px; margin: 5px; cursor: pointer; border-radius: 4px;
        }
        button:hover { background: #444; }
    </style>
</head>
<body>
    <h1>üß™ Permission Saving Fix Test</h1>
    
    <div>
        <button onclick="checkTables()">Check Tables</button>
        <button onclick="testPermissionUpdate()">Test Permission Update</button>
        <button onclick="createMissingRecords()">Create Missing Records</button>
    </div>
    
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://jtfucttzaswmqqhmmhfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZnVjdHR6YXN3bXFxaG1taGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NTUxMjEsImV4cCI6MjA2ODQzMTEyMX0.9lJqoqnTa3X5cKLNDTf7Vx7cQGz8bGZkTfkLQb0GEgY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let resultsDiv = document.getElementById('results');
        let currentUser = null;
        let currentOrg = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${timestamp}] ${message}`;
            resultsDiv.appendChild(div);
        }

        async function init() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                
                currentUser = user;
                if (user) {
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('*, organization:organizations(*)')
                        .eq('id', user.id)
                        .single();
                    
                    currentOrg = profile?.organization;
                    log(`‚úÖ Authenticated as ${user.email}`, 'success');
                    log(`üè¢ Organization: ${currentOrg?.name || 'None'}`, 'info');
                } else {
                    log('‚ùå Not authenticated', 'error');
                }
            } catch (err) {
                log(`‚ùå Auth error: ${err.message}`, 'error');
            }
        }

        window.checkTables = async function() {
            log('üîç Checking role_permissions table...', 'info');
            
            try {
                // Check if table exists
                const { data, error, count } = await supabase
                    .from('role_permissions')
                    .select('*', { count: 'exact' })
                    .limit(5);

                if (error) {
                    if (error.code === '42P01') {
                        log('‚ùå role_permissions table does not exist!', 'error');
                        log('üí° This table needs to be created for permissions to work', 'warning');
                        return;
                    } else {
                        throw error;
                    }
                }

                log(`‚úÖ role_permissions table exists with ${count} records`, 'success');
                
                if (data && data.length > 0) {
                    log('üìã Sample records:', 'info');
                    data.forEach(record => {
                        log(`  - Role: ${record.role_name}, Org: ${record.organization_id}, Permissions: ${record.permissions?.length || 0}`, 'info');
                    });
                }

                // Also check roles table
                const { data: rolesData, error: rolesError } = await supabase
                    .from('roles')
                    .select('*')
                    .limit(5);

                if (rolesError) {
                    log(`‚ùå Error checking roles table: ${rolesError.message}`, 'error');
                } else {
                    log(`‚úÖ roles table exists with ${rolesData.length} records`, 'success');
                }

            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        };

        window.testPermissionUpdate = async function() {
            if (!currentUser || !currentOrg) {
                log('‚ùå Need to be authenticated with an organization', 'error');
                return;
            }

            log('üß™ Testing permission update...', 'info');
            
            const testRole = 'admin';
            const testPermission = 'user-management';
            const orgId = currentOrg.id || 'global';

            try {
                // Check if record exists
                const { data: existing, error: existError } = await supabase
                    .from('role_permissions')
                    .select('*')
                    .eq('role_name', testRole)
                    .eq('organization_id', orgId)
                    .single();

                if (existError && existError.code !== 'PGRST116') {
                    throw existError;
                }

                if (!existing) {
                    log(`‚ö†Ô∏è No permission record found for ${testRole} in org ${orgId}`, 'warning');
                    log('üîß Creating test record...', 'info');
                    
                    const { data: newRecord, error: createError } = await supabase
                        .from('role_permissions')
                        .insert([{
                            role_name: testRole,
                            permissions: [testPermission],
                            organization_id: orgId,
                            display_name: 'Administrator',
                            description: 'Full system access'
                        }])
                        .select()
                        .single();

                    if (createError) {
                        throw createError;
                    }

                    log(`‚úÖ Created permission record: ${JSON.stringify(newRecord)}`, 'success');
                } else {
                    log(`‚úÖ Found existing record for ${testRole}`, 'success');
                    
                    // Test updating permissions
                    const currentPerms = existing.permissions || [];
                    const hasPermission = currentPerms.includes(testPermission);
                    const newPerms = hasPermission 
                        ? currentPerms.filter(p => p !== testPermission)
                        : [...currentPerms, testPermission];

                    log(`üîÑ ${hasPermission ? 'Removing' : 'Adding'} ${testPermission} permission`, 'info');

                    const { data: updateResult, error: updateError } = await supabase
                        .from('role_permissions')
                        .update({ permissions: newPerms })
                        .eq('role_name', testRole)
                        .eq('organization_id', orgId)
                        .select();

                    if (updateError) {
                        throw updateError;
                    }

                    if (!updateResult || updateResult.length === 0) {
                        log('‚ö†Ô∏è Update succeeded but no rows returned', 'warning');
                    } else {
                        log('‚úÖ Permission update successful!', 'success');
                        log(`üìã New permissions: ${JSON.stringify(newPerms)}`, 'info');
                    }
                }

            } catch (err) {
                log(`‚ùå Test failed: ${err.message}`, 'error');
            }
        };

        window.createMissingRecords = async function() {
            if (!currentOrg) {
                log('‚ùå Need an organization to create records', 'error');
                return;
            }

            log('üèóÔ∏è Creating missing role permission records...', 'info');
            
            const defaultRoles = [
                { name: 'admin', displayName: 'Administrator', permissions: ['user-management', 'role-management', 'billing', 'settings'] },
                { name: 'manager', displayName: 'Manager', permissions: ['user-management', 'customer-management', 'inventory-management'] },
                { name: 'user', displayName: 'User', permissions: ['customer-management', 'inventory-management'] },
                { name: 'owner', displayName: 'Owner', permissions: ['*'] }
            ];

            const orgId = currentOrg.id || 'global';

            for (const role of defaultRoles) {
                try {
                    // Check if exists
                    const { data: existing } = await supabase
                        .from('role_permissions')
                        .select('*')
                        .eq('role_name', role.name)
                        .eq('organization_id', orgId)
                        .single();

                    if (!existing) {
                        const { data: newRecord, error } = await supabase
                            .from('role_permissions')
                            .insert([{
                                role_name: role.name,
                                display_name: role.displayName,
                                permissions: role.permissions,
                                organization_id: orgId,
                                description: `Default permissions for ${role.displayName}`
                            }])
                            .select()
                            .single();

                        if (error) {
                            log(`‚ùå Failed to create ${role.name}: ${error.message}`, 'error');
                        } else {
                            log(`‚úÖ Created ${role.name} permissions`, 'success');
                        }
                    } else {
                        log(`‚ÑπÔ∏è ${role.name} already exists`, 'info');
                    }
                } catch (err) {
                    log(`‚ùå Error with ${role.name}: ${err.message}`, 'error');
                }
            }
        };

        // Auto-initialize
        init().then(() => {
            setTimeout(checkTables, 1000);
        });
    </script>
</body>
</html>
