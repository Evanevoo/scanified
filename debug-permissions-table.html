<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permissions Table</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #222; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        .info { color: #4488ff; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #333; color: #fff; border: 1px solid #555; 
            padding: 8px 16px; margin: 5px; cursor: pointer; border-radius: 4px;
        }
        button:hover { background: #444; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #555; padding: 8px; text-align: left; }
        th { background: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Permissions Table</h1>
        
        <div class="section">
            <h3>üîê Authentication Status</h3>
            <div id="auth-status">Loading...</div>
        </div>

        <div class="section">
            <h3>üìã Check role_permissions Table</h3>
            <div id="table-check">Loading...</div>
            <button onclick="checkTable()">Refresh Table Check</button>
        </div>

        <div class="section">
            <h3>üìä Current role_permissions Data</h3>
            <div id="permissions-data">Loading...</div>
            <button onclick="loadPermissions()">Refresh Data</button>
        </div>

        <div class="section">
            <h3>üß™ Test Permission Update</h3>
            <div>
                <label>Role Name:</label>
                <input type="text" id="test-role" placeholder="admin" value="admin">
                <label>Permission ID:</label>
                <input type="text" id="test-permission" placeholder="user-management" value="user-management">
                <button onclick="testPermissionUpdate()">Test Update</button>
            </div>
            <div id="test-result"></div>
        </div>

        <div class="section">
            <h3>üèóÔ∏è Create Missing Records</h3>
            <div>
                <button onclick="createMissingRecords()">Create Default Permission Records</button>
            </div>
            <div id="creation-result"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://jtfucttzaswmqqhmmhfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZnVjdHR6YXN3bXFxaG1taGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NTUxMjEsImV4cCI6MjA2ODQzMTEyMX0.9lJqoqnTa3X5cKLNDTf7Vx7cQGz8bGZkTfkLQb0GEgY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentOrganization = null;

        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                currentUser = user;
                
                const authDiv = document.getElementById('auth-status');
                if (error) {
                    authDiv.innerHTML = `<div class="error">‚ùå Auth Error: ${error.message}</div>`;
                } else if (user) {
                    // Get user profile
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('*, organization:organizations(*)')
                        .eq('id', user.id)
                        .single();

                    currentOrganization = profile?.organization;

                    authDiv.innerHTML = `
                        <div class="success">‚úÖ Authenticated</div>
                        <div class="info">üë§ User ID: ${user.id}</div>
                        <div class="info">üìß Email: ${user.email}</div>
                        <div class="info">üè¢ Organization: ${currentOrganization?.name || 'None'}</div>
                        <div class="info">üè¢ Org ID: ${currentOrganization?.id || 'None'}</div>
                    `;
                } else {
                    authDiv.innerHTML = `<div class="warning">‚ö†Ô∏è Not authenticated</div>`;
                }
            } catch (err) {
                document.getElementById('auth-status').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function checkTable() {
            try {
                console.log('üîç Checking role_permissions table...');
                
                // Try to query the table
                const { data, error, count } = await supabase
                    .from('role_permissions')
                    .select('*', { count: 'exact' })
                    .limit(1);

                const checkDiv = document.getElementById('table-check');
                
                if (error) {
                    if (error.code === '42P01') {
                        checkDiv.innerHTML = `
                            <div class="error">‚ùå Table does not exist</div>
                            <div class="warning">The role_permissions table needs to be created</div>
                            <div class="info">Error: ${error.message}</div>
                        `;
                    } else {
                        checkDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                    }
                } else {
                    checkDiv.innerHTML = `
                        <div class="success">‚úÖ Table exists</div>
                        <div class="info">üìä Total records: ${count}</div>
                        <div class="info">Sample data: <pre>${JSON.stringify(data, null, 2)}</pre></div>
                    `;
                }
            } catch (err) {
                document.getElementById('table-check').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function loadPermissions() {
            try {
                console.log('üìä Loading role_permissions data...');
                
                const { data: permissions, error } = await supabase
                    .from('role_permissions')
                    .select('*')
                    .order('role_name');

                const dataDiv = document.getElementById('permissions-data');
                
                if (error) {
                    dataDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                    return;
                }

                if (!permissions || permissions.length === 0) {
                    dataDiv.innerHTML = `<div class="warning">‚ö†Ô∏è No permission records found</div>`;
                    return;
                }

                let html = `<div class="success">‚úÖ Found ${permissions.length} permission records:</div>`;
                html += `<table>
                    <tr>
                        <th>Role Name</th>
                        <th>Display Name</th>
                        <th>Organization ID</th>
                        <th>Permissions Count</th>
                        <th>Permissions</th>
                    </tr>`;

                permissions.forEach(perm => {
                    html += `
                        <tr>
                            <td>${perm.role_name}</td>
                            <td>${perm.display_name || 'N/A'}</td>
                            <td>${perm.organization_id}</td>
                            <td>${perm.permissions?.length || 0}</td>
                            <td><code>${JSON.stringify(perm.permissions || [])}</code></td>
                        </tr>`;
                });
                html += `</table>`;

                dataDiv.innerHTML = html;
            } catch (err) {
                document.getElementById('permissions-data').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function testPermissionUpdate() {
            const roleName = document.getElementById('test-role').value.trim();
            const permissionId = document.getElementById('test-permission').value.trim();
            
            if (!roleName || !permissionId) {
                alert('Please enter both role name and permission ID');
                return;
            }

            try {
                console.log('üß™ Testing permission update...');
                
                const orgId = currentOrganization?.id || 'global';
                
                // First check if record exists
                const { data: existing, error: existError } = await supabase
                    .from('role_permissions')
                    .select('*')
                    .eq('role_name', roleName)
                    .eq('organization_id', orgId)
                    .single();

                console.log('üîç Existing record:', { existing, existError });

                let html = `<div class="info">üß™ Testing update for role: <code>${roleName}</code></div>`;
                html += `<div class="info">üéØ Permission ID: <code>${permissionId}</code></div>`;
                html += `<div class="info">üè¢ Organization ID: <code>${orgId}</code></div>`;

                if (existError && existError.code !== 'PGRST116') {
                    html += `<div class="error">‚ùå Error checking existing record: ${existError.message}</div>`;
                } else if (!existing) {
                    html += `<div class="warning">‚ö†Ô∏è No existing record found</div>`;
                    
                    // Try to create new record
                    const { data: newRecord, error: createError } = await supabase
                        .from('role_permissions')
                        .insert([{
                            role_name: roleName,
                            permissions: [permissionId],
                            organization_id: orgId,
                            display_name: roleName.charAt(0).toUpperCase() + roleName.slice(1),
                            description: `Permissions for ${roleName} role`
                        }])
                        .select()
                        .single();

                    if (createError) {
                        html += `<div class="error">‚ùå Failed to create record: ${createError.message}</div>`;
                    } else {
                        html += `<div class="success">‚úÖ Created new record: <pre>${JSON.stringify(newRecord, null, 2)}</pre></div>`;
                    }
                } else {
                    html += `<div class="success">‚úÖ Found existing record</div>`;
                    html += `<div class="info">Current permissions: <code>${JSON.stringify(existing.permissions || [])}</code></div>`;
                    
                    // Try to update
                    const currentPerms = existing.permissions || [];
                    const updatedPerms = currentPerms.includes(permissionId) 
                        ? currentPerms.filter(p => p !== permissionId)
                        : [...currentPerms, permissionId];

                    const { data: updateResult, error: updateError } = await supabase
                        .from('role_permissions')
                        .update({ permissions: updatedPerms })
                        .eq('role_name', roleName)
                        .eq('organization_id', orgId)
                        .select();

                    if (updateError) {
                        html += `<div class="error">‚ùå Update failed: ${updateError.message}</div>`;
                    } else {
                        html += `<div class="success">‚úÖ Update successful</div>`;
                        html += `<div class="info">Updated permissions: <code>${JSON.stringify(updatedPerms)}</code></div>`;
                        html += `<div class="info">Update result: <pre>${JSON.stringify(updateResult, null, 2)}</pre></div>`;
                    }
                }

                document.getElementById('test-result').innerHTML = html;
            } catch (err) {
                document.getElementById('test-result').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function createMissingRecords() {
            try {
                const orgId = currentOrganization?.id || 'global';
                const defaultRoles = ['admin', 'manager', 'user', 'owner'];
                
                let html = `<div class="info">üèóÔ∏è Creating default permission records for organization: <code>${orgId}</code></div>`;
                
                for (const roleName of defaultRoles) {
                    // Check if record exists
                    const { data: existing } = await supabase
                        .from('role_permissions')
                        .select('*')
                        .eq('role_name', roleName)
                        .eq('organization_id', orgId)
                        .single();

                    if (!existing) {
                        // Create new record
                        const { data: newRecord, error: createError } = await supabase
                            .from('role_permissions')
                            .insert([{
                                role_name: roleName,
                                permissions: [], // Start with empty permissions
                                organization_id: orgId,
                                display_name: roleName.charAt(0).toUpperCase() + roleName.slice(1),
                                description: `Permissions for ${roleName} role`
                            }])
                            .select()
                            .single();

                        if (createError) {
                            html += `<div class="error">‚ùå Failed to create ${roleName}: ${createError.message}</div>`;
                        } else {
                            html += `<div class="success">‚úÖ Created ${roleName} record</div>`;
                        }
                    } else {
                        html += `<div class="info">‚ÑπÔ∏è ${roleName} record already exists</div>`;
                    }
                }

                html += `<div class="success">üéâ Finished creating default records</div>`;
                document.getElementById('creation-result').innerHTML = html;
                
                // Refresh the data
                loadPermissions();
            } catch (err) {
                document.getElementById('creation-result').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        // Initialize on page load
        window.onload = function() {
            checkAuth();
            checkTable();
            loadPermissions();
        };
    </script>
</body>
</html>
