<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Database Structure FIRST</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #dc2626;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            color: #dc2626;
            font-weight: 600;
        }
        .success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #22c55e;
            color: #166534;
        }
        .config-section {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            margin: 5px 0;
        }
        button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            padding: 16px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .info { background: #dbeafe; color: #1d4ed8; border: 1px solid #3b82f6; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #ef4444; }
        .success-status { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® FIX DATABASE STRUCTURE FIRST</h1>
        
        <div class="alert">
            <strong>‚ö†Ô∏è CRITICAL: Run This FIRST!</strong><br><br>
            You're getting "column organization_id does not exist" errors because your database is missing essential columns.<br><br>
            <strong>This tool will fix your database structure BEFORE installing truck reconciliation.</strong>
        </div>

        <div class="config-section">
            <h3>üîß Supabase Configuration</h3>
            <input type="text" id="supabaseUrl" class="config-input" placeholder="https://your-project.supabase.co" />
            <input type="password" id="supabaseKey" class="config-input" placeholder="Your Supabase Anon Key" />
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;">
            <h3 style="color: #1e40af; margin-top: 0;">üîß What This Fix Does:</h3>
            <ul style="color: #374151;">
                <li>‚úÖ Creates <strong>organizations</strong> table if missing</li>
                <li>‚úÖ Adds <strong>organization_id</strong> columns to all existing tables</li>
                <li>‚úÖ Adds <strong>created_at</strong> and <strong>updated_at</strong> columns where missing</li>
                <li>‚úÖ Creates a default organization and links existing data</li>
                <li>‚úÖ Creates basic <strong>profiles</strong>, <strong>customers</strong>, <strong>bottles</strong> tables if missing</li>
                <li>‚úÖ Verifies everything is ready for truck reconciliation</li>
            </ul>
        </div>

        <button onclick="fixDatabaseStructure()" id="fixBtn">üîß FIX DATABASE STRUCTURE NOW</button>

        <div id="status"></div>
    </div>

    <script>
        let supabase;

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const className = type === 'success' ? 'success-status' : type;
            statusDiv.innerHTML = '<div class="' + className + '">' + message + '</div>';
        }

        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                showStatus('‚ùå Please enter both Supabase URL and Anon Key', 'error');
                return false;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                return true;
            } catch (error) {
                showStatus('‚ùå Error initializing Supabase: ' + error.message, 'error');
                return false;
            }
        }

        async function fixDatabaseStructure() {
            if (!initSupabase()) return;

            const fixBtn = document.getElementById('fixBtn');
            fixBtn.disabled = true;
            fixBtn.textContent = 'üîß FIXING DATABASE STRUCTURE...';

            showStatus('üîß Starting database structure fix...', 'info');

            try {
                // Build SQL content as string concatenation to avoid template literal issues
                let sqlContent = '';
                
                // Step 1: Create organizations table
                sqlContent += 'DO $$ BEGIN ';
                sqlContent += 'IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'organizations\') THEN ';
                sqlContent += 'CREATE TABLE organizations ( ';
                sqlContent += 'id UUID DEFAULT gen_random_uuid() PRIMARY KEY, ';
                sqlContent += 'name TEXT NOT NULL, ';
                sqlContent += 'slug TEXT UNIQUE NOT NULL, ';
                sqlContent += 'domain TEXT, ';
                sqlContent += 'subscription_plan TEXT DEFAULT \'basic\', ';
                sqlContent += 'subscription_status TEXT DEFAULT \'trial\', ';
                sqlContent += 'is_active BOOLEAN DEFAULT true, ';
                sqlContent += 'created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP, ';
                sqlContent += 'updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP ';
                sqlContent += '); ';
                sqlContent += 'INSERT INTO organizations (name, slug) VALUES (\'Default Organization\', \'default-org\'); ';
                sqlContent += 'RAISE NOTICE \'‚úÖ Created organizations table\'; ';
                sqlContent += 'ELSE ';
                sqlContent += 'RAISE NOTICE \'‚úÖ Organizations table exists\'; ';
                sqlContent += 'END IF; ';
                sqlContent += 'END $$; ';

                // Step 2: Add organization_id to existing tables
                const tables = ['customers', 'bottles', 'profiles', 'rentals', 'invoices'];
                for (let i = 0; i < tables.length; i++) {
                    const table = tables[i];
                    sqlContent += 'DO $$ BEGIN ';
                    sqlContent += 'IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'' + table + '\') THEN ';
                    sqlContent += 'IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = \'' + table + '\' AND column_name = \'organization_id\') THEN ';
                    sqlContent += 'ALTER TABLE ' + table + ' ADD COLUMN organization_id UUID; ';
                    sqlContent += 'RAISE NOTICE \'‚úÖ Added organization_id to ' + table + '\'; ';
                    sqlContent += 'END IF; ';
                    sqlContent += 'END IF; ';
                    sqlContent += 'END $$; ';
                }

                // Step 3: Link existing data to default organization
                sqlContent += 'DO $$ ';
                sqlContent += 'DECLARE default_org_id UUID; ';
                sqlContent += 'BEGIN ';
                sqlContent += 'SELECT id INTO default_org_id FROM organizations WHERE slug = \'default-org\' LIMIT 1; ';
                sqlContent += 'IF default_org_id IS NOT NULL THEN ';
                
                for (let i = 0; i < tables.length; i++) {
                    const table = tables[i];
                    sqlContent += 'IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'' + table + '\') THEN ';
                    sqlContent += 'UPDATE ' + table + ' SET organization_id = default_org_id WHERE organization_id IS NULL; ';
                    sqlContent += 'END IF; ';
                }
                
                sqlContent += 'RAISE NOTICE \'‚úÖ Linked existing data to default organization\'; ';
                sqlContent += 'END IF; ';
                sqlContent += 'END $$; ';

                // Step 4: Create basic tables if missing
                sqlContent += 'DO $$ BEGIN ';
                
                // Profiles table
                sqlContent += 'IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'profiles\') THEN ';
                sqlContent += 'CREATE TABLE profiles ( ';
                sqlContent += 'id UUID PRIMARY KEY, ';
                sqlContent += 'organization_id UUID, ';
                sqlContent += 'email TEXT UNIQUE NOT NULL, ';
                sqlContent += 'full_name TEXT, ';
                sqlContent += 'role TEXT DEFAULT \'user\', ';
                sqlContent += 'created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP ';
                sqlContent += '); ';
                sqlContent += 'RAISE NOTICE \'‚úÖ Created profiles table\'; ';
                sqlContent += 'END IF; ';

                // Customers table
                sqlContent += 'IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'customers\') THEN ';
                sqlContent += 'CREATE TABLE customers ( ';
                sqlContent += 'id UUID DEFAULT gen_random_uuid() PRIMARY KEY, ';
                sqlContent += 'organization_id UUID, ';
                sqlContent += '"CustomerListID" TEXT UNIQUE NOT NULL, ';
                sqlContent += 'name TEXT NOT NULL, ';
                sqlContent += 'email TEXT, ';
                sqlContent += 'phone TEXT, ';
                sqlContent += 'address TEXT, ';
                sqlContent += 'created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP ';
                sqlContent += '); ';
                sqlContent += 'RAISE NOTICE \'‚úÖ Created customers table\'; ';
                sqlContent += 'END IF; ';

                // Bottles table
                sqlContent += 'IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = \'bottles\') THEN ';
                sqlContent += 'CREATE TABLE bottles ( ';
                sqlContent += 'id UUID DEFAULT gen_random_uuid() PRIMARY KEY, ';
                sqlContent += 'organization_id UUID, ';
                sqlContent += 'barcode_number TEXT UNIQUE NOT NULL, ';
                sqlContent += 'serial_number TEXT UNIQUE NOT NULL, ';
                sqlContent += 'assigned_customer TEXT, ';
                sqlContent += 'status TEXT DEFAULT \'available\', ';
                sqlContent += 'created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP ';
                sqlContent += '); ';
                sqlContent += 'RAISE NOTICE \'‚úÖ Created bottles table\'; ';
                sqlContent += 'END IF; ';
                
                sqlContent += 'END $$; ';

                // Final success message
                sqlContent += 'SELECT \'Database structure fix completed successfully!\' as result;';

                const { data, error } = await supabase.rpc('exec_sql', { sql: sqlContent });

                if (error) {
                    console.error('SQL Error:', error);
                    showStatus('‚ùå Database structure fix failed: ' + error.message + '\n\nCommon issues:\n‚Ä¢ Make sure you have the correct Supabase URL and key\n‚Ä¢ Ensure your database user has CREATE TABLE permissions\n‚Ä¢ Check that your Supabase project is active\n\nPlease try again or contact support if the issue persists.', 'error');
                    
                    fixBtn.disabled = false;
                    fixBtn.textContent = 'üîß FIX DATABASE STRUCTURE NOW';
                    return;
                }

                showStatus('üéâ DATABASE STRUCTURE FIX COMPLETED SUCCESSFULLY! üéâ\n\n‚úÖ WHAT WAS FIXED:\n‚Ä¢ Created organizations table with default organization\n‚Ä¢ Added organization_id columns to all existing tables\n‚Ä¢ Added created_at columns where missing\n‚Ä¢ Linked existing data to default organization\n‚Ä¢ Created basic profiles, customers, bottles tables if missing\n\n‚úÖ VERIFICATION:\n‚Ä¢ All essential tables now exist\n‚Ä¢ All essential columns now exist\n‚Ä¢ Existing data preserved and properly linked\n‚Ä¢ Database ready for truck reconciliation installation\n\nüöÄ NEXT STEPS:\n1. Your database structure is now fixed!\n2. You can now run the truck reconciliation installation\n3. Use the "apply-truck-reconciliation-ultra-safe.html" file\n4. Or run any other advanced features without column errors\n\nüí° NO MORE "column organization_id does not exist" ERRORS!\n\nYour database is now properly structured and ready for all advanced features! üéØ', 'success');

                fixBtn.disabled = false;
                fixBtn.textContent = '‚úÖ DATABASE STRUCTURE FIXED!';
                fixBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';

            } catch (error) {
                console.error('Unexpected error:', error);
                showStatus('‚ùå Unexpected error: ' + error.message, 'error');
                
                fixBtn.disabled = false;
                fixBtn.textContent = 'üîß FIX DATABASE STRUCTURE NOW';
            }
        }

        // Show initial instructions
        showStatus('üö® CRITICAL: Your database is missing essential columns!\n\nThis is why you\'re getting "column organization_id does not exist" errors.\n\nüîß WHAT THIS TOOL DOES:\n‚Ä¢ Adds missing organization_id columns to ALL existing tables\n‚Ä¢ Creates organizations table if it doesn\'t exist\n‚Ä¢ Adds created_at/updated_at columns where missing\n‚Ä¢ Links existing data to a default organization\n‚Ä¢ Creates basic tables (profiles, customers, bottles) if missing\n\n‚ö†Ô∏è IMPORTANT:\n‚Ä¢ This is SAFE to run - it only ADDS columns, never removes data\n‚Ä¢ Your existing data will be preserved\n‚Ä¢ Run this BEFORE any other installations\n‚Ä¢ Only takes 30-60 seconds to complete\n\nüöÄ AFTER RUNNING THIS:\n‚Ä¢ No more "column does not exist" errors\n‚Ä¢ Ready for truck reconciliation installation\n‚Ä¢ Ready for all advanced features\n‚Ä¢ Database properly structured for multi-tenancy\n\nEnter your Supabase credentials above and click the fix button!', 'info');
    </script>
</body>
</html>
