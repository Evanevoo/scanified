<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Join Codes Migration</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        pre {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .step {
            border-left: 4px solid #3b82f6;
            padding-left: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Apply Join Codes Migration</h1>
    
    <div class="card">
        <h2>üìã Migration Overview</h2>
        <p>This tool will create the organization join codes system in your Supabase database.</p>
        <div class="status info">
            <strong>What this creates:</strong><br>
            ‚Ä¢ organization_join_codes table<br>
            ‚Ä¢ PostgreSQL functions for code management<br>
            ‚Ä¢ Row Level Security policies<br>
            ‚Ä¢ Indexes for performance
        </div>
    </div>

    <div class="card">
        <h2>üîë Supabase Configuration</h2>
        <p>Enter your Supabase credentials to apply the migration:</p>
        
        <div style="margin: 10px 0;">
            <label>Supabase URL:</label><br>
            <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div style="margin: 10px 0;">
            <label>Service Role Key (for admin operations):</label><br>
            <input type="password" id="serviceKey" placeholder="eyJ..." 
                   style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div class="status warning">
            <strong>‚ö†Ô∏è Security Note:</strong> The service role key is only used locally in your browser and is not transmitted anywhere except to your Supabase instance.
        </div>
        
        <button class="btn" onclick="testConnection()">Test Connection</button>
        <button class="btn" onclick="applyMigration()" id="migrateBtn" disabled>Apply Migration</button>
    </div>

    <div class="card">
        <h2>üìä Migration Status</h2>
        <div id="status">
            <div class="status info">Ready to apply migration. Please test connection first.</div>
        </div>
    </div>

    <div class="card">
        <h2>üîç Migration Steps</h2>
        <div class="step">
            <h3>Step 1: Create Table</h3>
            <p>Creates the <code>organization_join_codes</code> table with all necessary columns.</p>
        </div>
        <div class="step">
            <h3>Step 2: Add Functions</h3>
            <p>Creates PostgreSQL functions for code generation, validation, and cleanup.</p>
        </div>
        <div class="step">
            <h3>Step 3: Set Up Security</h3>
            <p>Enables Row Level Security and creates appropriate policies.</p>
        </div>
        <div class="step">
            <h3>Step 4: Create Indexes</h3>
            <p>Adds database indexes for optimal performance.</p>
        </div>
    </div>

    <script>
        let supabase = null;

        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('serviceKey').value;
            
            if (!url || !key) {
                updateStatus('Please enter both Supabase URL and Service Role Key', 'error');
                return;
            }

            try {
                updateStatus('Testing connection...', 'info');
                
                supabase = window.supabase.createClient(url, key);
                
                // Test connection by fetching organizations
                const { data, error } = await supabase
                    .from('organizations')
                    .select('count(*)')
                    .limit(1);
                
                if (error) {
                    throw new Error(error.message);
                }
                
                updateStatus('‚úÖ Connection successful! Ready to apply migration.', 'success');
                document.getElementById('migrateBtn').disabled = false;
                
            } catch (error) {
                updateStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                document.getElementById('migrateBtn').disabled = true;
            }
        }

        async function applyMigration() {
            if (!supabase) {
                updateStatus('Please test connection first', 'error');
                return;
            }

            try {
                updateStatus('üöÄ Applying migration...', 'info');

                // Step 1: Create table
                updateStatus('Step 1: Creating organization_join_codes table...', 'info');
                
                const createTableSQL = `
                    CREATE TABLE IF NOT EXISTS organization_join_codes (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE NOT NULL,
                        code TEXT NOT NULL UNIQUE,
                        created_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '24 hours'),
                        used_at TIMESTAMP WITH TIME ZONE NULL,
                        used_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
                        is_active BOOLEAN DEFAULT true,
                        max_uses INTEGER DEFAULT 1,
                        current_uses INTEGER DEFAULT 0,
                        notes TEXT
                    );
                `;

                const { error: tableError } = await supabase.rpc('exec_sql', { query: createTableSQL });
                if (tableError) throw new Error(`Table creation failed: ${tableError.message}`);

                // Step 2: Create indexes
                updateStatus('Step 2: Creating indexes...', 'info');
                
                const indexSQL = `
                    CREATE INDEX IF NOT EXISTS idx_organization_join_codes_code ON organization_join_codes(code);
                    CREATE INDEX IF NOT EXISTS idx_organization_join_codes_org_id ON organization_join_codes(organization_id);
                    CREATE INDEX IF NOT EXISTS idx_organization_join_codes_active ON organization_join_codes(is_active, expires_at);
                `;

                const { error: indexError } = await supabase.rpc('exec_sql', { query: indexSQL });
                if (indexError) throw new Error(`Index creation failed: ${indexError.message}`);

                // Step 3: Create functions
                updateStatus('Step 3: Creating PostgreSQL functions...', 'info');
                
                const functionsSQL = `
                    -- Function to generate unique 6-digit numeric code
                    CREATE OR REPLACE FUNCTION generate_numeric_join_code()
                    RETURNS TEXT AS $$
                    DECLARE
                        code TEXT;
                        attempts INTEGER := 0;
                        max_attempts INTEGER := 100;
                    BEGIN
                        LOOP
                            code := LPAD(FLOOR(RANDOM() * 1000000)::TEXT, 6, '0');
                            
                            IF NOT EXISTS (
                                SELECT 1 FROM organization_join_codes 
                                WHERE code = code 
                                AND is_active = true 
                                AND expires_at > NOW()
                            ) THEN
                                RETURN code;
                            END IF;
                            
                            attempts := attempts + 1;
                            IF attempts >= max_attempts THEN
                                RAISE EXCEPTION 'Unable to generate unique code after % attempts', max_attempts;
                            END IF;
                        END LOOP;
                    END;
                    $$ LANGUAGE plpgsql;

                    -- Function to create a new join code
                    CREATE OR REPLACE FUNCTION create_organization_join_code(
                        p_organization_id UUID,
                        p_created_by UUID,
                        p_expires_hours INTEGER DEFAULT 24,
                        p_max_uses INTEGER DEFAULT 1,
                        p_notes TEXT DEFAULT NULL
                    )
                    RETURNS TABLE(code TEXT, expires_at TIMESTAMP WITH TIME ZONE) AS $$
                    DECLARE
                        new_code TEXT;
                        expiry_time TIMESTAMP WITH TIME ZONE;
                    BEGIN
                        new_code := generate_numeric_join_code();
                        expiry_time := NOW() + (p_expires_hours || ' hours')::INTERVAL;
                        
                        INSERT INTO organization_join_codes (
                            organization_id, code, created_by, expires_at, max_uses, notes
                        ) VALUES (
                            p_organization_id, new_code, p_created_by, expiry_time, p_max_uses, p_notes
                        );
                        
                        RETURN QUERY SELECT new_code, expiry_time;
                    END;
                    $$ LANGUAGE plpgsql;

                    -- Function to validate and use a join code
                    CREATE OR REPLACE FUNCTION use_organization_join_code(
                        p_code TEXT,
                        p_used_by UUID
                    )
                    RETURNS TABLE(success BOOLEAN, organization_id UUID, message TEXT) AS $$
                    DECLARE
                        code_record RECORD;
                    BEGIN
                        SELECT * INTO code_record FROM organization_join_codes
                        WHERE code = p_code AND is_active = true;
                        
                        IF code_record IS NULL THEN
                            RETURN QUERY SELECT false, NULL::UUID, 'Invalid join code';
                            RETURN;
                        END IF;
                        
                        IF code_record.expires_at < NOW() THEN
                            RETURN QUERY SELECT false, NULL::UUID, 'Join code has expired';
                            RETURN;
                        END IF;
                        
                        IF code_record.current_uses >= code_record.max_uses THEN
                            RETURN QUERY SELECT false, NULL::UUID, 'Join code has already been used';
                            RETURN;
                        END IF;
                        
                        UPDATE organization_join_codes
                        SET current_uses = current_uses + 1,
                            used_at = CASE WHEN used_at IS NULL THEN NOW() ELSE used_at END,
                            used_by = CASE WHEN used_by IS NULL THEN p_used_by ELSE used_by END,
                            is_active = CASE WHEN (current_uses + 1) >= max_uses THEN false ELSE is_active END
                        WHERE id = code_record.id;
                        
                        RETURN QUERY SELECT true, code_record.organization_id, 'Join code validated successfully';
                    END;
                    $$ LANGUAGE plpgsql;

                    -- Function to get active codes for an organization
                    CREATE OR REPLACE FUNCTION get_organization_join_codes(p_organization_id UUID)
                    RETURNS TABLE(
                        id UUID, code TEXT, created_at TIMESTAMP WITH TIME ZONE,
                        expires_at TIMESTAMP WITH TIME ZONE, created_by_name TEXT,
                        current_uses INTEGER, max_uses INTEGER, is_active BOOLEAN, notes TEXT
                    ) AS $$
                    BEGIN
                        RETURN QUERY
                        SELECT ojc.id, ojc.code, ojc.created_at, ojc.expires_at,
                               COALESCE(p.full_name, 'Unknown') as created_by_name,
                               ojc.current_uses, ojc.max_uses, ojc.is_active, ojc.notes
                        FROM organization_join_codes ojc
                        LEFT JOIN profiles p ON ojc.created_by = p.id
                        WHERE ojc.organization_id = p_organization_id
                        ORDER BY ojc.created_at DESC;
                    END;
                    $$ LANGUAGE plpgsql;
                `;

                const { error: functionsError } = await supabase.rpc('exec_sql', { query: functionsSQL });
                if (functionsError) throw new Error(`Functions creation failed: ${functionsError.message}`);

                // Step 4: Enable RLS and create policies
                updateStatus('Step 4: Setting up Row Level Security...', 'info');
                
                const rlsSQL = `
                    ALTER TABLE organization_join_codes ENABLE ROW LEVEL SECURITY;

                    CREATE POLICY "Users can view organization join codes" ON organization_join_codes
                        FOR SELECT USING (
                            organization_id IN (
                                SELECT organization_id FROM profiles WHERE id = auth.uid()
                            )
                        );

                    CREATE POLICY "Admins can create join codes" ON organization_join_codes
                        FOR INSERT WITH CHECK (
                            EXISTS (
                                SELECT 1 FROM profiles 
                                WHERE id = auth.uid() 
                                AND organization_id = organization_join_codes.organization_id
                                AND (role = 'admin' OR role = 'owner')
                            )
                        );

                    CREATE POLICY "Admins can update join codes" ON organization_join_codes
                        FOR UPDATE USING (
                            EXISTS (
                                SELECT 1 FROM profiles 
                                WHERE id = auth.uid() 
                                AND organization_id = organization_join_codes.organization_id
                                AND (role = 'admin' OR role = 'owner')
                            )
                        );
                `;

                const { error: rlsError } = await supabase.rpc('exec_sql', { query: rlsSQL });
                if (rlsError) throw new Error(`RLS setup failed: ${rlsError.message}`);

                // Test the system
                updateStatus('Step 5: Testing the system...', 'info');
                
                const { data: testData, error: testError } = await supabase
                    .rpc('generate_numeric_join_code');
                
                if (testError) throw new Error(`System test failed: ${testError.message}`);

                updateStatus(`üéâ Migration completed successfully! 
                
‚úÖ Table created: organization_join_codes
‚úÖ Indexes created for performance
‚úÖ PostgreSQL functions installed
‚úÖ Row Level Security enabled
‚úÖ System tested - generated test code: ${testData}

Your OAuth organization linking system is now ready to use!

Next steps:
1. Navigate to /organization-join-codes as an admin
2. Generate your first join code
3. Test the OAuth flow at /connect-organization`, 'success');

            } catch (error) {
                updateStatus(`‚ùå Migration failed: ${error.message}`, 'error');
                console.error('Migration error:', error);
            }
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html>
