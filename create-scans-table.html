<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Scans Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374151;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .status.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .sql-preview {
            background-color: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .help-text {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Create Scans Table</h1>
        
        <div class="help-text">
            <strong>‚ö†Ô∏è Important:</strong> This will create the scans table needed for the mobile app to sync barcode scans. 
            Make sure you have the correct Supabase credentials and that the organizations and profiles tables already exist.
        </div>

        <div class="form-group">
            <label for="supabaseUrl">Supabase URL:</label>
            <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
        </div>

        <div class="form-group">
            <label for="supabaseKey">Supabase Service Role Key:</label>
            <input type="password" id="supabaseKey" placeholder="Your service role key">
        </div>

        <button onclick="createScansTable()">Create Scans Table</button>

        <div class="sql-preview" id="sqlPreview">
-- SQL Script Preview:
-- This will create the scans table with proper structure and RLS policies
-- 
-- Table: scans
-- Columns: id, organization_id, barcode_number, action, location, notes, scanned_by, created_at, updated_at
-- 
-- Features:
-- ‚úÖ Row Level Security enabled
-- ‚úÖ Proper indexes for performance
-- ‚úÖ RLS policies for multi-tenancy
-- ‚úÖ Automatic timestamp updates
-- ‚úÖ Foreign key constraints
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        async function createScansTable() {
            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseKey = document.getElementById('supabaseKey').value.trim();
            const statusDiv = document.getElementById('status');
            const button = document.querySelector('button');

            if (!supabaseUrl || !supabaseKey) {
                showStatus('Please enter both Supabase URL and Service Role Key', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'Creating Table...';
            showStatus('Creating scans table...', 'info');

            try {
                const sqlScript = `
-- Create scans table for gas cylinder mobile app
CREATE TABLE IF NOT EXISTS scans (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    barcode_number VARCHAR(255) NOT NULL,
    action VARCHAR(50) NOT NULL CHECK (action IN ('in', 'out', 'locate', 'fill')),
    location TEXT,
    notes TEXT,
    scanned_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_scans_organization_id ON scans(organization_id);
CREATE INDEX IF NOT EXISTS idx_scans_barcode_number ON scans(barcode_number);
CREATE INDEX IF NOT EXISTS idx_scans_action ON scans(action);
CREATE INDEX IF NOT EXISTS idx_scans_created_at ON scans(created_at);
CREATE INDEX IF NOT EXISTS idx_scans_scanned_by ON scans(scanned_by);

-- Enable Row Level Security
ALTER TABLE scans ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY "Users can view scans from their organization" ON scans
    FOR SELECT USING (
        organization_id IN (
            SELECT organization_id FROM profiles 
            WHERE id = auth.uid()
        )
    );

CREATE POLICY "Users can insert scans for their organization" ON scans
    FOR INSERT WITH CHECK (
        organization_id IN (
            SELECT organization_id FROM profiles 
            WHERE id = auth.uid()
        )
    );

CREATE POLICY "Users can update scans from their organization" ON scans
    FOR UPDATE USING (
        organization_id IN (
            SELECT organization_id FROM profiles 
            WHERE id = auth.uid()
        )
    );

CREATE POLICY "Users can delete scans from their organization" ON scans
    FOR DELETE USING (
        organization_id IN (
            SELECT organization_id FROM profiles 
            WHERE id = auth.uid()
        )
    );

-- Create function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_scans_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to automatically update updated_at
CREATE TRIGGER update_scans_updated_at_trigger
    BEFORE UPDATE ON scans
    FOR EACH ROW
    EXECUTE FUNCTION update_scans_updated_at();
                `;

                const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseKey}`,
                        'apikey': supabaseKey
                    },
                    body: JSON.stringify({
                        sql: sqlScript
                    })
                });

                if (response.ok) {
                    showStatus('‚úÖ Scans table created successfully! The mobile app can now sync barcode scans.', 'success');
                } else {
                    const errorData = await response.text();
                    console.error('Error response:', errorData);
                    showStatus(`‚ùå Failed to create scans table: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error creating scans table: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Create Scans Table';
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        // Load saved credentials if available
        window.onload = function() {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;
        };

        // Save credentials
        document.getElementById('supabaseUrl').addEventListener('input', function() {
            localStorage.setItem('supabaseUrl', this.value);
        });
        document.getElementById('supabaseKey').addEventListener('input', function() {
            localStorage.setItem('supabaseKey', this.value);
        });
    </script>
</body>
</html>
