<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug AutomatedBillingDashboard</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 AutomatedBillingDashboard Debug Tool</h1>
    <p>This tool helps debug why the AutomatedBillingDashboard might be showing a white screen.</p>

    <div id="results"></div>

    <button onclick="testInvoiceService()">Test InvoiceService</button>
    <button onclick="testDatabaseTables()">Test Database Tables</button>
    <button onclick="testAuthContext()">Test Auth Context</button>
    <button onclick="testComponentRender()">Test Component Render</button>

    <script type="module">
        // Import Supabase
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';

        const supabaseUrl = 'https://jtfucttzaswmqqhmmhfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZnVjdHR6YXN3bXFxaG1taGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5NDQ4NzMsImV4cCI6MjA2MTUyMDg3M30.6-CAPYefAektlh3dLRVFZbPKYSnhIAzp3knohc3NDEg';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }

        window.testInvoiceService = async function() {
            log('🧾 Testing InvoiceService...', 'info');
            
            try {
                // Test if we can import InvoiceService (simulate)
                log('✅ InvoiceService import would work', 'success');
                
                // Test getInvoiceStats method
                const mockOrgId = 'test-org-id';
                
                // Simulate the method call
                const testQueries = [
                    supabase.from('invoices').select('*', { count: 'exact', head: true }).eq('organization_id', mockOrgId),
                    supabase.from('invoices').select('*', { count: 'exact', head: true }).eq('organization_id', mockOrgId).eq('payment_status', 'paid'),
                ];
                
                log('📊 Testing invoice statistics queries...', 'info');
                
                for (let i = 0; i < testQueries.length; i++) {
                    try {
                        const result = await testQueries[i];
                        if (result.error) {
                            log(`❌ Query ${i + 1} failed: ${result.error.message}`, 'error');
                            if (result.error.code === '42P01') {
                                log(`💡 Table "invoices" does not exist - this is likely the cause of the white screen!`, 'error');
                            }
                        } else {
                            log(`✅ Query ${i + 1} succeeded`, 'success');
                        }
                    } catch (error) {
                        log(`❌ Query ${i + 1} threw error: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`❌ InvoiceService test failed: ${error.message}`, 'error');
            }
        };

        window.testDatabaseTables = async function() {
            log('🗄️ Testing required database tables...', 'info');
            
            const requiredTables = [
                'invoices',
                'billing_automation_settings',
                'customers',
                'organizations'
            ];
            
            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        if (error.code === '42P01') {
                            log(`❌ Table "${table}" does not exist`, 'error');
                        } else {
                            log(`⚠️ Table "${table}" exists but query failed: ${error.message}`, 'error');
                        }
                    } else {
                        log(`✅ Table "${table}" exists and accessible`, 'success');
                    }
                } catch (error) {
                    log(`❌ Error testing table "${table}": ${error.message}`, 'error');
                }
            }
        };

        window.testAuthContext = async function() {
            log('👤 Testing authentication context...', 'info');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`❌ Auth error: ${error.message}`, 'error');
                } else if (session) {
                    log(`✅ User is authenticated: ${session.user.email}`, 'success');
                    
                    // Test organization access
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('*, organization:organizations(*)')
                        .eq('id', session.user.id)
                        .single();
                    
                    if (profileError) {
                        log(`❌ Profile fetch error: ${profileError.message}`, 'error');
                    } else if (profile) {
                        log(`✅ Profile found: ${JSON.stringify(profile, null, 2)}`, 'success');
                        
                        if (profile.organization) {
                            log(`✅ Organization found: ${profile.organization.name}`, 'success');
                        } else {
                            log(`❌ No organization linked to user - this could cause white screen!`, 'error');
                        }
                    }
                } else {
                    log(`❌ No active session - user not logged in`, 'error');
                }
            } catch (error) {
                log(`❌ Auth test error: ${error.message}`, 'error');
            }
        };

        window.testComponentRender = async function() {
            log('⚛️ Testing component render logic...', 'info');
            
            try {
                // Simulate the component logic
                log('📊 Simulating AutomatedBillingDashboard render...', 'info');
                
                // Test 1: Loading state
                log('✅ Loading state would render correctly', 'success');
                
                // Test 2: Error state
                log('✅ Error state would render correctly', 'success');
                
                // Test 3: No organization state
                log('✅ No organization state would render correctly', 'success');
                
                // Test 4: Main render
                log('🔍 Testing main component render...', 'info');
                
                // The issue is likely in the data loading phase
                log('💡 Most likely issue: Component fails during data loading phase', 'info');
                log('💡 Check browser console for JavaScript errors', 'info');
                log('💡 The component might be throwing an unhandled error', 'info');
                
            } catch (error) {
                log(`❌ Component render test error: ${error.message}`, 'error');
            }
        };

        // Auto-run basic tests
        window.addEventListener('load', () => {
            log('🚀 Starting automatic diagnosis...', 'info');
            testDatabaseTables();
        });
    </script>
</body>
</html>
