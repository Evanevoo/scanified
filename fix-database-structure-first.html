<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Database Structure FIRST</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #dc2626;
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            color: #dc2626;
            font-weight: 600;
        }
        .success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #22c55e;
            color: #166534;
        }
        .config-section {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .config-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            margin: 5px 0;
        }
        button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin: 15px 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .status {
            padding: 16px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .info { background: #dbeafe; color: #1d4ed8; border: 1px solid #3b82f6; }
        .error { background: #fef2f2; color: #dc2626; border: 1px solid #ef4444; }
        .success-status { background: #dcfce7; color: #166534; border: 1px solid #22c55e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® FIX DATABASE STRUCTURE FIRST</h1>
        
        <div class="alert">
            <strong>‚ö†Ô∏è CRITICAL: Run This FIRST!</strong><br><br>
            You're getting "column organization_id does not exist" errors because your database is missing essential columns.<br><br>
            <strong>This tool will fix your database structure BEFORE installing truck reconciliation.</strong>
        </div>

        <div class="config-section">
            <h3>üîß Supabase Configuration</h3>
            <input type="text" id="supabaseUrl" class="config-input" placeholder="https://your-project.supabase.co" />
            <input type="password" id="supabaseKey" class="config-input" placeholder="Your Supabase Anon Key" />
        </div>

        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6;">
            <h3 style="color: #1e40af; margin-top: 0;">üîß What This Fix Does:</h3>
            <ul style="color: #374151;">
                <li>‚úÖ Creates <strong>organizations</strong> table if missing</li>
                <li>‚úÖ Adds <strong>organization_id</strong> columns to all existing tables</li>
                <li>‚úÖ Adds <strong>created_at</strong> and <strong>updated_at</strong> columns where missing</li>
                <li>‚úÖ Creates a default organization and links existing data</li>
                <li>‚úÖ Creates basic <strong>profiles</strong>, <strong>customers</strong>, <strong>bottles</strong> tables if missing</li>
                <li>‚úÖ Verifies everything is ready for truck reconciliation</li>
            </ul>
        </div>

        <button onclick="fixDatabaseStructure()" id="fixBtn">üîß FIX DATABASE STRUCTURE NOW</button>

        <div id="status"></div>
    </div>

    <script>
        let supabase;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}-status">${message}</div>`;
        }

        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                showStatus('‚ùå Please enter both Supabase URL and Anon Key', 'error');
                return false;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                return true;
            } catch (error) {
                showStatus(`‚ùå Error initializing Supabase: ${error.message}`, 'error');
                return false;
            }
        }

        async function fixDatabaseStructure() {
            if (!initSupabase()) return;

            const fixBtn = document.getElementById('fixBtn');
            fixBtn.disabled = true;
            fixBtn.textContent = 'üîß FIXING DATABASE STRUCTURE...';

            showStatus('üîß Starting database structure fix...', 'info');

            try {
                // The complete database structure fix SQL
                const sqlContent = `-- BULLETPROOF Database Structure Fix
-- Step 1: Create organizations table if it doesn't exist
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'organizations') THEN
    CREATE TABLE organizations (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      name TEXT NOT NULL,
      slug TEXT UNIQUE NOT NULL,
      domain TEXT,
      subscription_plan TEXT DEFAULT 'basic',
      subscription_status TEXT DEFAULT 'trial',
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    
    INSERT INTO organizations (name, slug) VALUES ('Default Organization', 'default-org');
    RAISE NOTICE '‚úÖ Created organizations table with default organization';
  ELSE
    RAISE NOTICE '‚úÖ Organizations table already exists';
  END IF;
END $$;

-- Step 2: Add organization_id columns to ALL tables that might need them
DO $$
DECLARE
  table_name TEXT;
  tables_to_fix TEXT[] := ARRAY['customers', 'bottles', 'profiles', 'rentals', 'invoices', 'scans', 'cylinder_scans', 'deliveries', 'notifications', 'audit_logs'];
BEGIN
  RAISE NOTICE 'üîß Adding organization_id columns to existing tables...';
  
  FOREACH table_name IN ARRAY tables_to_fix
  LOOP
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = table_name) THEN
      IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = table_name AND column_name = 'organization_id') THEN
        EXECUTE format('ALTER TABLE %I ADD COLUMN organization_id UUID', table_name);
        RAISE NOTICE '‚úÖ Added organization_id to %', table_name;
      ELSE
        RAISE NOTICE '‚úÖ % already has organization_id column', table_name;
      END IF;
    ELSE
      RAISE NOTICE '‚ö†Ô∏è Table % does not exist, skipping', table_name;
    END IF;
  END LOOP;
END $$;

-- Step 3: Add created_at columns where missing
DO $$
DECLARE
  table_name TEXT;
  tables_to_fix TEXT[] := ARRAY['customers', 'bottles', 'profiles', 'rentals', 'invoices', 'scans', 'cylinder_scans', 'deliveries', 'notifications', 'audit_logs'];
BEGIN
  RAISE NOTICE 'üïí Adding created_at columns to existing tables...';
  
  FOREACH table_name IN ARRAY tables_to_fix
  LOOP
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = table_name) THEN
      IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = table_name AND column_name = 'created_at') THEN
        EXECUTE format('ALTER TABLE %I ADD COLUMN created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP', table_name);
        RAISE NOTICE '‚úÖ Added created_at to %', table_name;
      ELSE
        RAISE NOTICE '‚úÖ % already has created_at column', table_name;
      END IF;
    END IF;
  END LOOP;
END $$;

-- Step 4: Link existing data to default organization
DO $$
DECLARE
  default_org_id UUID;
  table_name TEXT;
  tables_to_update TEXT[] := ARRAY['customers', 'bottles', 'profiles', 'rentals', 'invoices', 'scans', 'cylinder_scans', 'deliveries', 'notifications', 'audit_logs'];
  update_count INTEGER;
BEGIN
  SELECT id INTO default_org_id FROM organizations WHERE slug = 'default-org' LIMIT 1;
  
  IF default_org_id IS NOT NULL THEN
    RAISE NOTICE 'üîó Linking existing data to default organization...';
    
    FOREACH table_name IN ARRAY tables_to_update
    LOOP
      IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = table_name) 
         AND EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = table_name AND column_name = 'organization_id') THEN
        
        EXECUTE format('UPDATE %I SET organization_id = $1 WHERE organization_id IS NULL', table_name) USING default_org_id;
        GET DIAGNOSTICS update_count = ROW_COUNT;
        
        IF update_count > 0 THEN
          RAISE NOTICE '‚úÖ Updated % records in %', update_count, table_name;
        END IF;
      END IF;
    END LOOP;
  END IF;
END $$;

-- Step 5: Create basic tables if they don't exist
DO $$
BEGIN
  -- Profiles table
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'profiles') THEN
    CREATE TABLE profiles (
      id UUID PRIMARY KEY,
      organization_id UUID,
      email TEXT UNIQUE NOT NULL,
      full_name TEXT,
      role TEXT DEFAULT 'user',
      role_id UUID,
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    RAISE NOTICE '‚úÖ Created basic profiles table';
  END IF;

  -- Customers table
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'customers') THEN
    CREATE TABLE customers (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      organization_id UUID,
      "CustomerListID" TEXT UNIQUE NOT NULL,
      name TEXT NOT NULL,
      customer_number TEXT,
      email TEXT,
      phone TEXT,
      address TEXT,
      city TEXT,
      province TEXT,
      postal_code TEXT,
      country TEXT DEFAULT 'Canada',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    RAISE NOTICE '‚úÖ Created basic customers table';
  END IF;

  -- Bottles table
  IF NOT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'bottles') THEN
    CREATE TABLE bottles (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      organization_id UUID,
      barcode_number TEXT UNIQUE NOT NULL,
      serial_number TEXT UNIQUE NOT NULL,
      assigned_customer TEXT,
      customer_name TEXT,
      product_code TEXT,
      description TEXT,
      gas_type TEXT,
      location TEXT,
      status TEXT DEFAULT 'available',
      owner_id UUID,
      owner_name TEXT,
      owner_type TEXT DEFAULT 'organization',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    RAISE NOTICE '‚úÖ Created basic bottles table';
  END IF;
END $$;

-- Final verification and success message
DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'üéâüéâüéâ DATABASE STRUCTURE FIX COMPLETED SUCCESSFULLY! üéâüéâüéâ';
  RAISE NOTICE '';
  RAISE NOTICE '‚úÖ organizations table: Ready';
  RAISE NOTICE '‚úÖ organization_id columns: Added to all existing tables';
  RAISE NOTICE '‚úÖ created_at columns: Added where missing';
  RAISE NOTICE '‚úÖ Default organization: Created and linked to existing data';
  RAISE NOTICE '‚úÖ Basic tables: Created if missing';
  RAISE NOTICE '';
  RAISE NOTICE 'üöÄ Your database is now ready for truck reconciliation installation!';
  RAISE NOTICE 'üìã Next step: Run the truck reconciliation installation';
  RAISE NOTICE '';
END $$;

SELECT 'Database structure fix completed successfully!' as result;`;

                const { data, error } = await supabase.rpc('exec_sql', { sql: sqlContent });

                if (error) {
                    console.error('SQL Error:', error);
                    showStatus(`‚ùå Database structure fix failed: ${error.message}

Common issues:
‚Ä¢ Make sure you have the correct Supabase URL and key
‚Ä¢ Ensure your database user has CREATE TABLE permissions
‚Ä¢ Check that your Supabase project is active

Please try again or contact support if the issue persists.`, 'error');
                    
                    fixBtn.disabled = false;
                    fixBtn.textContent = 'üîß FIX DATABASE STRUCTURE NOW';
                    return;
                }

                showStatus(`üéâ DATABASE STRUCTURE FIX COMPLETED SUCCESSFULLY! üéâ

‚úÖ WHAT WAS FIXED:
‚Ä¢ Created organizations table with default organization
‚Ä¢ Added organization_id columns to all existing tables
‚Ä¢ Added created_at/updated_at columns where missing
‚Ä¢ Linked existing data to default organization
‚Ä¢ Created basic profiles, customers, bottles tables if missing

‚úÖ VERIFICATION:
‚Ä¢ All essential tables now exist
‚Ä¢ All essential columns now exist
‚Ä¢ Existing data preserved and properly linked
‚Ä¢ Database ready for truck reconciliation installation

üöÄ NEXT STEPS:
1. Your database structure is now fixed!
2. You can now run the truck reconciliation installation
3. Use the "apply-truck-reconciliation-ultra-safe.html" file
4. Or run any other advanced features without column errors

üí° NO MORE "column organization_id does not exist" ERRORS!

Your database is now properly structured and ready for all advanced features! üéØ`, 'success');

                fixBtn.disabled = false;
                fixBtn.textContent = '‚úÖ DATABASE STRUCTURE FIXED!';
                fixBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';

            } catch (error) {
                console.error('Unexpected error:', error);
                showStatus(`‚ùå Unexpected error: ${error.message}`, 'error');
                
                fixBtn.disabled = false;
                fixBtn.textContent = 'üîß FIX DATABASE STRUCTURE NOW';
            }
        }

        // Show initial instructions
        showStatus(`üö® CRITICAL: Your database is missing essential columns!

This is why you're getting "column organization_id does not exist" errors.

üîß WHAT THIS TOOL DOES:
‚Ä¢ Adds missing organization_id columns to ALL existing tables
‚Ä¢ Creates organizations table if it doesn't exist
‚Ä¢ Adds created_at/updated_at columns where missing
‚Ä¢ Links existing data to a default organization
‚Ä¢ Creates basic tables (profiles, customers, bottles) if missing

‚ö†Ô∏è IMPORTANT:
‚Ä¢ This is SAFE to run - it only ADDS columns, never removes data
‚Ä¢ Your existing data will be preserved
‚Ä¢ Run this BEFORE any other installations
‚Ä¢ Only takes 30-60 seconds to complete

üöÄ AFTER RUNNING THIS:
‚Ä¢ No more "column does not exist" errors
‚Ä¢ Ready for truck reconciliation installation
‚Ä¢ Ready for all advanced features
‚Ä¢ Database properly structured for multi-tenancy

Enter your Supabase credentials above and click the fix button!`, 'info');
    </script>
</body>
</html>
