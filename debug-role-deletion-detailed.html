<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Deletion Debug Tool</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #222; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
        .info { color: #4488ff; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #333; color: #fff; border: 1px solid #555; 
            padding: 8px 16px; margin: 5px; cursor: pointer; border-radius: 4px;
        }
        button:hover { background: #444; }
        input, select { 
            background: #333; color: #fff; border: 1px solid #555; 
            padding: 8px; margin: 5px; border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #555; padding: 8px; text-align: left; }
        th { background: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Role Deletion Debug Tool</h1>
        
        <div class="section">
            <h3>üîê Authentication Status</h3>
            <div id="auth-status">Loading...</div>
            <button onclick="checkAuth()">Refresh Auth</button>
        </div>

        <div class="section">
            <h3>üìã Current Roles in Database</h3>
            <div id="roles-list">Loading...</div>
            <button onclick="loadRoles()">Refresh Roles</button>
        </div>

        <div class="section">
            <h3>üõ°Ô∏è RLS Policies Check</h3>
            <div id="rls-info">Loading...</div>
            <button onclick="checkRLS()">Check RLS Policies</button>
        </div>

        <div class="section">
            <h3>üóëÔ∏è Test Role Deletion</h3>
            <div>
                <label>Role ID to Delete:</label>
                <input type="text" id="role-id-input" placeholder="Enter role UUID" style="width: 300px;">
                <button onclick="testDeletion()">Test Delete</button>
            </div>
            <div id="deletion-result"></div>
        </div>

        <div class="section">
            <h3>üîß Manual Role Creation (for testing)</h3>
            <div>
                <label>Role Name:</label>
                <input type="text" id="test-role-name" placeholder="test-role">
                <button onclick="createTestRole()">Create Test Role</button>
            </div>
            <div id="creation-result"></div>
        </div>

        <div class="section">
            <h3>üìä Role Usage Check</h3>
            <div id="role-usage">Loading...</div>
            <button onclick="checkRoleUsage()">Check Role Usage</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://jtfucttzaswmqqhmmhfb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0ZnVjdHR6YXN3bXFxaG1taGZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NTUxMjEsImV4cCI6MjA2ODQzMTEyMX0.9lJqoqnTa3X5cKLNDTf7Vx7cQGz8bGZkTfkLQb0GEgY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                currentUser = user;
                
                const authDiv = document.getElementById('auth-status');
                if (error) {
                    authDiv.innerHTML = `<div class="error">‚ùå Auth Error: ${error.message}</div>`;
                } else if (user) {
                    authDiv.innerHTML = `
                        <div class="success">‚úÖ Authenticated</div>
                        <div class="info">üë§ User ID: ${user.id}</div>
                        <div class="info">üìß Email: ${user.email}</div>
                        <div class="info">üîë Role: ${user.user_metadata?.role || 'N/A'}</div>
                    `;
                } else {
                    authDiv.innerHTML = `<div class="warning">‚ö†Ô∏è Not authenticated</div>`;
                }
            } catch (err) {
                document.getElementById('auth-status').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function loadRoles() {
            try {
                console.log('üîç Fetching roles from database...');
                
                const { data: roles, error } = await supabase
                    .from('roles')
                    .select('*')
                    .order('name');

                console.log('üìä Roles query result:', { roles, error });

                const rolesDiv = document.getElementById('roles-list');
                
                if (error) {
                    rolesDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                    return;
                }

                if (!roles || roles.length === 0) {
                    rolesDiv.innerHTML = `<div class="warning">‚ö†Ô∏è No roles found in database</div>`;
                    return;
                }

                let html = `<div class="success">‚úÖ Found ${roles.length} roles:</div>`;
                html += `<table>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Display Name</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>`;

                roles.forEach(role => {
                    html += `
                        <tr>
                            <td><code>${role.id}</code></td>
                            <td>${role.name}</td>
                            <td>${role.display_name || 'N/A'}</td>
                            <td>${new Date(role.created_at).toLocaleString()}</td>
                            <td>
                                <button onclick="fillRoleId('${role.id}')">Use for Delete Test</button>
                            </td>
                        </tr>`;
                });
                html += `</table>`;

                rolesDiv.innerHTML = html;
            } catch (err) {
                document.getElementById('roles-list').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        function fillRoleId(roleId) {
            document.getElementById('role-id-input').value = roleId;
        }

        async function checkRLS() {
            try {
                console.log('üõ°Ô∏è Checking RLS policies...');
                
                // Check if we can read from roles table
                const { data: readTest, error: readError } = await supabase
                    .from('roles')
                    .select('id')
                    .limit(1);

                // Try to check policies (this might not work due to RLS on system tables)
                const { data: policies, error: policyError } = await supabase
                    .rpc('get_table_policies', { table_name: 'roles' })
                    .then(result => result)
                    .catch(err => ({ data: null, error: err }));

                const rlsDiv = document.getElementById('rls-info');
                let html = '';

                if (readError) {
                    html += `<div class="error">‚ùå Cannot read roles table: ${readError.message}</div>`;
                } else {
                    html += `<div class="success">‚úÖ Can read roles table (found ${readTest?.length || 0} roles)</div>`;
                }

                if (policyError || !policies) {
                    html += `<div class="warning">‚ö†Ô∏è Cannot check RLS policies directly</div>`;
                } else {
                    html += `<div class="info">üìã RLS Policies: <pre>${JSON.stringify(policies, null, 2)}</pre></div>`;
                }

                // Test current user's permissions
                html += `<div class="info">üîç Testing current user permissions...</div>`;
                
                rlsDiv.innerHTML = html;
            } catch (err) {
                document.getElementById('rls-info').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function testDeletion() {
            const roleId = document.getElementById('role-id-input').value.trim();
            if (!roleId) {
                alert('Please enter a role ID');
                return;
            }

            try {
                console.log('üóëÔ∏è Testing deletion of role:', roleId);

                // First, check if the role exists
                const { data: existsCheck, error: existsError } = await supabase
                    .from('roles')
                    .select('*')
                    .eq('id', roleId)
                    .single();

                console.log('üîç Role exists check:', { existsCheck, existsError });

                let html = `<div class="info">üîç Testing deletion of role: <code>${roleId}</code></div>`;

                if (existsError) {
                    if (existsError.code === 'PGRST116') {
                        html += `<div class="warning">‚ö†Ô∏è Role not found in database</div>`;
                    } else {
                        html += `<div class="error">‚ùå Error checking role existence: ${existsError.message}</div>`;
                    }
                } else {
                    html += `<div class="success">‚úÖ Role exists: ${existsCheck.name} (${existsCheck.display_name})</div>`;
                    
                    // Now try to delete it
                    const { data: deleteResult, error: deleteError } = await supabase
                        .from('roles')
                        .delete()
                        .eq('id', roleId)
                        .select();

                    console.log('üóëÔ∏è Delete attempt result:', { deleteResult, deleteError });

                    if (deleteError) {
                        html += `<div class="error">‚ùå Delete failed: ${deleteError.message}</div>`;
                        if (deleteError.code) {
                            html += `<div class="error">Error Code: ${deleteError.code}</div>`;
                        }
                    } else if (!deleteResult || deleteResult.length === 0) {
                        html += `<div class="warning">‚ö†Ô∏è Delete command succeeded but no rows were deleted</div>`;
                        html += `<div class="warning">This usually indicates RLS policy blocking the deletion</div>`;
                    } else {
                        html += `<div class="success">‚úÖ Role deleted successfully!</div>`;
                        html += `<div class="info">Deleted data: <pre>${JSON.stringify(deleteResult, null, 2)}</pre></div>`;
                        // Refresh the roles list
                        loadRoles();
                    }
                }

                document.getElementById('deletion-result').innerHTML = html;
            } catch (err) {
                document.getElementById('deletion-result').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function createTestRole() {
            const roleName = document.getElementById('test-role-name').value.trim();
            if (!roleName) {
                alert('Please enter a role name');
                return;
            }

            try {
                const { data: newRole, error } = await supabase
                    .from('roles')
                    .insert([
                        {
                            name: roleName,
                            display_name: roleName.charAt(0).toUpperCase() + roleName.slice(1)
                        }
                    ])
                    .select()
                    .single();

                const resultDiv = document.getElementById('creation-result');
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to create role: ${error.message}</div>`;
                } else {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Test role created successfully!</div>
                        <div class="info">Role ID: <code>${newRole.id}</code></div>
                        <div class="info">Name: ${newRole.name}</div>
                    `;
                    // Refresh roles list
                    loadRoles();
                    // Fill in the role ID for deletion test
                    document.getElementById('role-id-input').value = newRole.id;
                }
            } catch (err) {
                document.getElementById('creation-result').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        async function checkRoleUsage() {
            try {
                const { data: roles, error: rolesError } = await supabase
                    .from('roles')
                    .select('*');

                if (rolesError) {
                    document.getElementById('role-usage').innerHTML = `<div class="error">‚ùå Error: ${rolesError.message}</div>`;
                    return;
                }

                let html = `<div class="info">üîç Checking role usage...</div>`;
                html += `<table>
                    <tr>
                        <th>Role Name</th>
                        <th>Role ID</th>
                        <th>Users (by role_id)</th>
                        <th>Users (by role text)</th>
                    </tr>`;

                for (const role of roles) {
                    // Check usage by role_id (UUID)
                    const { count: uuidCount } = await supabase
                        .from('profiles')
                        .select('*', { count: 'exact', head: true })
                        .eq('role_id', role.id);

                    // Check usage by role text
                    const { count: textCount } = await supabase
                        .from('profiles')
                        .select('*', { count: 'exact', head: true })
                        .eq('role', role.name);

                    html += `
                        <tr>
                            <td>${role.name}</td>
                            <td><code>${role.id}</code></td>
                            <td>${uuidCount || 0}</td>
                            <td>${textCount || 0}</td>
                        </tr>`;
                }

                html += `</table>`;
                document.getElementById('role-usage').innerHTML = html;
            } catch (err) {
                document.getElementById('role-usage').innerHTML = `<div class="error">‚ùå Error: ${err.message}</div>`;
            }
        }

        // Initialize on page load
        window.onload = function() {
            checkAuth();
            loadRoles();
            checkRLS();
            checkRoleUsage();
        };
    </script>
</body>
</html>
